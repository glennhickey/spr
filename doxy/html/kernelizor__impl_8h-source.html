<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SPR: kernelizor_impl.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>kernelizor_impl.h</h1><a href="kernelizor__impl_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#ifndef _KERNELIZOR_IMPL_H</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define _KERNELIZOR_IMPL_H</span>
00003 <span class="preprocessor"></span>
00004 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00005 <span class="preprocessor">#include "<a class="code" href="treemanager_8h.html">treemanager.h</a>"</span>
00006 
00011 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00012"></a><a class="code" href="classKernelizor.html#a0">00012</a> <a class="code" href="classKernelizor.html#d0">Kernelizor&lt;T&gt;::Kernelizor</a>(<a class="code" href="classTreeManager.html">TreeManager&lt;T&gt;</a>&amp; man) : _man(&amp;man)
00013 {
00014   <a class="code" href="classKernelizor.html#p2">_numLeaves</a> = (<a class="code" href="classKernelizor.html#p1">_man</a>-&gt;treeSize() + 4) / 3;
00015   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i)
00016   {
00017     <a class="code" href="classKernelizor.html#p4">_lookup</a>[i] = (<span class="keywordtype">int</span>*)malloc(<a class="code" href="classKernelizor.html#p2">_numLeaves</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00018     <a class="code" href="classKernelizor.html#p5">_btable</a>[i].resize(<a class="code" href="classKernelizor.html#p1">_man</a>-&gt;treeSize());
00019     <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[i].resize(<a class="code" href="classKernelizor.html#p1">_man</a>-&gt;treeSize());
00020     <span class="keywordflow">if</span> (i &gt; 1)
00021       <a class="code" href="classKernelizor.html#p8">_chainTable</a>[i].resize(<a class="code" href="classKernelizor.html#p1">_man</a>-&gt;treeSize());  <span class="comment">//only need for rule2</span>
00022     <a class="code" href="classKernelizor.html#p6">_ftable</a>[i].resize(<a class="code" href="classKernelizor.html#p1">_man</a>-&gt;treeSize());
00023   }
00024   <a class="code" href="classKernelizor.html#p1">_man</a>-&gt;createTree(<a class="code" href="classKernelizor.html#p0">_t</a>[2]);
00025   <a class="code" href="classKernelizor.html#p1">_man</a>-&gt;createTree(<a class="code" href="classKernelizor.html#p0">_t</a>[3]);
00026 }
00027 
00028 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00029"></a><a class="code" href="classKernelizor.html#a1">00029</a> <a class="code" href="classKernelizor.html#a1">Kernelizor&lt;T&gt;::~Kernelizor</a>()
00030 {
00031   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i)
00032   {
00033     free(<a class="code" href="classKernelizor.html#p4">_lookup</a>[i]);
00034   }
00035   <span class="comment">// note to self:  _t[2,3] are lost (though not leaked)</span>
00036   <span class="comment">// shouldn't be a big deal as there will be at most 4 kernelizors</span>
00037 }
00038 
00043 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00044"></a><a class="code" href="classKernelizor.html#a2">00044</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classKernelizor.html#a2">Kernelizor&lt;T&gt;::setT1</a>(<a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; tree)
00045 {
00046   <a class="code" href="classKernelizor.html#p0">_t</a>[0] = tree; <span class="comment">// reference copy</span>
00047   <a class="code" href="classKernelizor.html#b0">loadTree</a>(tree, 0);
00048 }
00049 
00054 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00055"></a><a class="code" href="classKernelizor.html#a3">00055</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classKernelizor.html#a3">Kernelizor&lt;T&gt;::setT2</a>(<a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; tree)
00056 {
00057   <a class="code" href="classKernelizor.html#p0">_t</a>[1] = tree; <span class="comment">// reference copy</span>
00058   <a class="code" href="classKernelizor.html#b0">loadTree</a>(tree, 1);
00059 }
00060 
00065 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00066"></a><a class="code" href="classKernelizor.html#b0">00066</a> <span class="keywordtype">void</span> <a class="code" href="classKernelizor.html#b0">Kernelizor&lt;T&gt;::loadTree</a>(<a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; tree, <span class="keywordtype">int</span> num)
00067 {
00068   <a class="code" href="classKernelizor.html#p5">_btable</a>[num].loadTree(tree);
00069   <a class="code" href="classKernelizor.html#p6">_ftable</a>[num].loadTree(tree, <a class="code" href="classKernelizor.html#p5">_btable</a>[num]);
00070   <span class="keywordflow">if</span> (num &gt; 1)
00071   {
00072     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[num].resize(<a class="code" href="classKernelizor.html#p3">_tempSize</a>);
00073     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[num].loadTree(tree, <a class="code" href="classKernelizor.html#p5">_btable</a>[num]);
00074     <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[num].resize(tree.size());
00075   }
00076   <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[num].loadTree(tree, <a class="code" href="classKernelizor.html#p5">_btable</a>[num]);
00077   T label;
00078   <span class="keywordtype">int</span> n = num &gt; 1 ? <a class="code" href="classKernelizor.html#p3">_tempSize</a> - 1 : tree.size() - 1;
00079   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; n; ++i)
00080   {
00081     <span class="keywordflow">if</span> (tree[i].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a>)
00082     {
00083       label = tree[i].myLabel();
00084       assert(label &lt; <a class="code" href="classKernelizor.html#p2">_numLeaves</a>);
00085       <a class="code" href="classKernelizor.html#p4">_lookup</a>[num][label] = i;
00086     }
00087   }  
00088 }
00089 
00099 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00100"></a><a class="code" href="classKernelizor.html#a4">00100</a> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classKernelizor.html#a4">Kernelizor&lt;T&gt;::kernelize</a>()
00101 {
00102   <span class="comment">// DEBUG</span>
00103   <span class="comment">//std::cout &lt;&lt; "Kernelizing " &lt;&lt; _t[0] &lt;&lt; " with " &lt;&lt; _t[1] &lt;&lt; std::endl;</span>
00104 
00105   <span class="comment">// reload a flag table for t2 as it could have been modified</span>
00106   <span class="comment">// t1 was just loaded so we don't need to reload the flagtable for it</span>
00107   <span class="comment">// ditto cherrytable</span>
00108   <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].loadTree(<a class="code" href="classKernelizor.html#p0">_t</a>[1], <a class="code" href="classKernelizor.html#p5">_btable</a>[1]);
00109   <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[1].loadTree(<a class="code" href="classKernelizor.html#p0">_t</a>[1], <a class="code" href="classKernelizor.html#p5">_btable</a>[1]);
00110     
00111   <span class="keywordtype">int</span> c = <a class="code" href="classKernelizor.html#b1">rule1</a>();
00112   <a class="code" href="classKernelizor.html#b5">copyToTemp</a>();
00113   c += <a class="code" href="classKernelizor.html#b2">rule2</a>();
00114   <a class="code" href="classKernelizor.html#b6">copyFromTemp</a>();
00115 
00116   <span class="comment">// update flagtable with rekernelization info</span>
00117   <span class="comment">// (remove freeze flags from surrounding brackets of flagged subtrees)</span>
00118   <span class="comment">// (add freeze flags to first neighbours of flagged chains)</span>
00119   <span class="comment">// don't need to update _ftable[1] since only the first tree is ever</span>
00120   <span class="comment">// rekernelized by sprsearch.</span>
00121   <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].updateRekern();
00122 
00123   <span class="comment">// DEBUG</span>
00124   <span class="comment">// std::cout &lt;&lt; *this &lt;&lt; std::endl;</span>
00125 
00126   <span class="keywordflow">return</span> c;
00127 }
00128 
00132 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00133"></a><a class="code" href="classKernelizor.html#a5">00133</a> <span class="keyword">inline</span> size_t <a class="code" href="classKernelizor.html#a5">Kernelizor&lt;T&gt;::numLeaves</a>()<span class="keyword"> const</span>
00134 <span class="keyword"></span>{
00135   <span class="keywordflow">return</span> <a class="code" href="classKernelizor.html#p2">_numLeaves</a>;
00136 }
00137 
00142 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00143"></a><a class="code" href="classKernelizor.html#a6">00143</a> <span class="keyword">inline</span> <span class="keyword">const</span> <a class="code" href="classBracketTable.html">BracketTable&lt;T&gt;</a>&amp; <a class="code" href="classKernelizor.html#a6">Kernelizor&lt;T&gt;::getBTable</a>(<span class="keywordtype">int</span> num)<span class="keyword"> const</span>
00144 <span class="keyword"></span>{
00145   assert(num &gt;= 0 &amp;&amp; num &lt;= 3);
00146   <span class="keywordflow">return</span> <a class="code" href="classKernelizor.html#p5">_btable</a>[num];
00147 } 
00148 
00153 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00154"></a><a class="code" href="classKernelizor.html#a7">00154</a> <span class="keyword">inline</span> <span class="keyword">const</span> <a class="code" href="classFlagTable.html">FlagTable&lt;T&gt;</a>&amp; <a class="code" href="classKernelizor.html#a7">Kernelizor&lt;T&gt;::getFTable</a>(<span class="keywordtype">int</span> num)<span class="keyword"> const</span>
00155 <span class="keyword"></span>{
00156   assert(num &gt;= 0 &amp;&amp; num &lt;= 3);
00157   <span class="keywordflow">return</span> <a class="code" href="classKernelizor.html#p6">_ftable</a>[num];
00158 } 
00159 
00165 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00166"></a><a class="code" href="classKernelizor.html#a8">00166</a> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">int</span>* <a class="code" href="classKernelizor.html#a8">Kernelizor&lt;T&gt;::getLookup</a>(<span class="keywordtype">int</span> num)<span class="keyword"> const</span>
00167 <span class="keyword"></span>{
00168   assert(num &gt;= 0 &amp;&amp; num &lt;= 3);
00169   <span class="keywordflow">return</span> <a class="code" href="classKernelizor.html#p4">_lookup</a>[num];
00170 } 
00171 
00177 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00178"></a><a class="code" href="classKernelizor.html#b1">00178</a> <span class="keywordtype">int</span> <a class="code" href="classKernelizor.html#b1">Kernelizor&lt;T&gt;::rule1</a>()
00179 {
00180   <span class="keywordtype">int</span> i;
00181   <span class="keywordtype">int</span> cherry1, cherry2, cherryPos1, cherryPos2;
00182   <span class="keywordtype">int</span> remainingLeaves = <a class="code" href="classKernelizor.html#p2">_numLeaves</a>;
00183 
00184   <span class="comment">// Set rule state to 1 in the flag tables.  this allows us to verify</span>
00185   <span class="comment">// later which leaves were flagged as subtrees and which we flagged as</span>
00186   <span class="comment">// chains</span>
00187    <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].setRuleState(0);
00188    <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].setRuleState(0);
00189 
00190   <span class="keywordflow">for</span> (size_t i = 0; i &lt; <a class="code" href="classKernelizor.html#p2">_numLeaves</a>; ++i)
00191     <a class="code" href="classKernelizor.html#p9">_queue</a>.push(i);
00192 
00193   <span class="keywordflow">while</span> (!<a class="code" href="classKernelizor.html#p9">_queue</a>.empty() &amp;&amp; remainingLeaves &gt; 3)
00194   {
00195     i = <a class="code" href="classKernelizor.html#p9">_queue</a>.front();
00196     <a class="code" href="classKernelizor.html#p9">_queue</a>.pop();
00197 
00198     <span class="comment">// find label of cherry leaf in each tree (-1 if doesn't exist)    </span>
00199     cherryPos1 = <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[0][<a class="code" href="classKernelizor.html#p4">_lookup</a>[0][i]];
00200     cherry1 = cherryPos1 &gt;= 0 ? <a class="code" href="classKernelizor.html#p0">_t</a>[0][cherryPos1].myLabel() : -1;
00201     
00202     cherryPos2 = <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[1][_lookup[1][i]];
00203     cherry2 = cherryPos2 &gt;= 0 ? <a class="code" href="classKernelizor.html#p0">_t</a>[1][cherryPos2].myLabel() : -1;
00204         
00205     <span class="comment">// find common cherry</span>
00206     <span class="keywordflow">if</span> (cherry1 &gt;= 0 &amp;&amp; cherry1 == cherry2)
00207     {
00208       cherry1 = std::min(cherry1, i);
00209       cherry2 = std::max(cherry2, i);
00210       cherryPos1 = _lookup[0][cherry2];
00211       cherryPos2 = _lookup[1][cherry2];
00212 
00213       <span class="comment">// only proceed if max label not already flagged</span>
00214       <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p6">_ftable</a>[0].isDel(cherryPos1) == <span class="keyword">false</span> &amp;&amp;
00215           <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].isDel(cherryPos2) == <span class="keyword">false</span>)
00216       {
00217         <span class="comment">// flag minimum leaf and its enclosing brackets for deletion</span>
00218         <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].flagLeaf(_lookup[0][cherry2]);
00219         <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].flagLeaf(_lookup[1][cherry2]);
00220         --remainingLeaves;
00221 
00222         <span class="comment">// flag maximum leaf as frozen for rekernelization</span>
00223         <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].setFrozen(_lookup[0][cherry1], <span class="keyword">true</span>);
00224         <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].setFrozen(_lookup[1][cherry1], <span class="keyword">true</span>);
00225         
00226         <span class="comment">// update the cherry positions in the cherry table to reflect</span>
00227         <span class="comment">// the fact the the old cherry was flagged</span>
00228         <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[0].resetNeighbour(_lookup[0][cherry1],  
00229           <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].cherryPos(_lookup[0][cherry1]));
00230 
00231         <span class="comment">// DEBUG</span>
00232         <span class="comment">// std::cout &lt;&lt; "resetting neighbour of " &lt;&lt; cherry1 &lt;&lt; " with "</span>
00233         <span class="comment">//          &lt;&lt; _t[0][_ftable[0].cherryPos(_lookup[0][cherry1])]</span>
00234         <span class="comment">//          &lt;&lt; std::endl;</span>
00235 
00236         <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[1].resetNeighbour(_lookup[1][cherry1],  
00237           <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].cherryPos(_lookup[1][cherry1]));
00238 
00239         <a class="code" href="classKernelizor.html#p9">_queue</a>.push(cherry1);
00240       }
00241     }
00242   }
00243   <span class="keywordflow">return</span> <a class="code" href="classKernelizor.html#p2">_numLeaves</a> - remainingLeaves;
00244 }
00245 
00252 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00253"></a><a class="code" href="classKernelizor.html#b2">00253</a> <span class="keywordtype">int</span> <a class="code" href="classKernelizor.html#b2">Kernelizor&lt;T&gt;::rule2</a>()
00254 {
00255   <span class="keywordtype">int</span> count = 0;
00256 
00257   <span class="comment">// rebuild tables for reduced trees</span>
00258   <a class="code" href="classKernelizor.html#b0">loadTree</a>(<a class="code" href="classKernelizor.html#p0">_t</a>[2], 2);
00259   <a class="code" href="classKernelizor.html#b0">loadTree</a>(<a class="code" href="classKernelizor.html#p0">_t</a>[3], 3);
00260 
00261   <span class="comment">// Set rule state to 2 in the flag tables.  this allows us to verify</span>
00262   <span class="comment">// later which leaves were flagged as subtrees and which we flagged as</span>
00263   <span class="comment">// chains</span>
00264    <a class="code" href="classKernelizor.html#p6">_ftable</a>[2].setRuleState(1);
00265    <a class="code" href="classKernelizor.html#p6">_ftable</a>[3].setRuleState(1);
00266 
00267   <span class="keywordtype">int</span> i, linkCount;
00268   T links[2];
00269 
00270   <span class="comment">// visits each node at most twice. </span>
00271   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classKernelizor.html#p3">_tempSize</a>; ++i)
00272   {
00273     <span class="comment">// check if chain endpoint in first tree</span>
00274     <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a>)
00275     {
00276       <span class="comment">// see if it is a common chain endpoint</span>
00277       linkCount = <a class="code" href="classKernelizor.html#b3">chainLinks</a>(<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myLabel(), links);
00278 
00279 <span class="preprocessor">#ifndef NORULE2</span>
00280 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (linkCount == 1)
00281       {
00282    count += <a class="code" href="classKernelizor.html#b4">flagChain</a>(<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myLabel(), links[0]);
00283       }
00284 <span class="preprocessor">#endif</span>
00285 <span class="preprocessor"></span>    }
00286   }
00287   
00288   <span class="keywordflow">return</span> count;
00289 }
00290 
00295 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00296"></a><a class="code" href="classKernelizor.html#b5">00296</a> <span class="keywordtype">void</span> <a class="code" href="classKernelizor.html#b5">Kernelizor&lt;T&gt;::copyToTemp</a>()
00297 {
00298   <a class="code" href="classKernelizor.html#p3">_tempSize</a> = 0;
00299   <span class="keywordtype">int</span> tempSize2 = 0;
00300   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; _man-&gt;treeSize(); ++i)
00301   {
00302     <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p6">_ftable</a>[0].isDel(i) == <span class="keyword">false</span>)
00303     {
00304       <a class="code" href="classKernelizor.html#p0">_t</a>[2][<a class="code" href="classKernelizor.html#p3">_tempSize</a>++] = <a class="code" href="classKernelizor.html#p0">_t</a>[0][i];
00305     }
00306     <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p6">_ftable</a>[1].isDel(i) == <span class="keyword">false</span>)
00307     {
00308       <a class="code" href="classKernelizor.html#p0">_t</a>[3][tempSize2++] = <a class="code" href="classKernelizor.html#p0">_t</a>[1][i];
00309     }
00310   }
00311 
00312   assert(<a class="code" href="classKernelizor.html#p3">_tempSize</a> == tempSize2);
00313 }
00314 
00315 
00326 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00327"></a><a class="code" href="classKernelizor.html#b3">00327</a> <span class="keywordtype">int</span> <a class="code" href="classKernelizor.html#b3">Kernelizor&lt;T&gt;::chainLinks</a>(T label, T labels[2])
00328 {
00329   <span class="keywordtype">int</span> pos1 = <a class="code" href="classKernelizor.html#p4">_lookup</a>[2][label];
00330   <span class="keywordtype">int</span> pos2 = <a class="code" href="classKernelizor.html#p4">_lookup</a>[3][label];
00331   T lab1, lab2;
00332   <span class="keywordtype">int</span> count = 0;
00333   <span class="keywordtype">int</span> i, j; 
00334   <span class="keywordtype">int</span> k1 = 0;
00335   <span class="keywordtype">int</span> k2 = 0;
00336 
00337   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classKernelizor.html#p8">_chainTable</a>[2][pos1]._num; ++i)
00338   {
00339     <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="classKernelizor.html#p8">_chainTable</a>[3][pos2]._num; ++j)
00340     {
00341       lab1 = <a class="code" href="classKernelizor.html#p0">_t</a>[2][<a class="code" href="classKernelizor.html#p8">_chainTable</a>[2][pos1]._pos[i]].myLabel();
00342       lab2 = <a class="code" href="classKernelizor.html#p0">_t</a>[3][<a class="code" href="classKernelizor.html#p8">_chainTable</a>[3][pos2]._pos[j]].myLabel();
00343 
00344       <span class="comment">// found a common link</span>
00345       <span class="keywordflow">if</span> (lab1 == lab2)
00346       {
00347         <span class="keywordflow">if</span> (count == 0)
00348         {
00349           labels[count++] = 
00350             <a class="code" href="classKernelizor.html#p0">_t</a>[2][<a class="code" href="classKernelizor.html#p8">_chainTable</a>[2][pos1]._pos[i]].myLabel();
00351         }
00352         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count &gt; 0)
00353         {
00354           <span class="comment">// verify that we are not adding two leaves that are a cherry</span>
00355           <span class="comment">// in one of the trees</span>
00356           k1 = <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[2][<a class="code" href="classKernelizor.html#p4">_lookup</a>[2][lab1]];
00357           k2 = <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[3][_lookup[3][lab1]];
00358           
00359           <span class="keywordflow">if</span> ((k1 &gt;= 0 &amp;&amp; <a class="code" href="classKernelizor.html#p0">_t</a>[2][k1].myLabel() == labels[0]) || 
00360               (k2 &gt;= 0 &amp;&amp; <a class="code" href="classKernelizor.html#p0">_t</a>[3][k2].myLabel() == labels[0]))
00361           {
00362             labels[0] = std::max(labels[0], lab1);
00363           }
00364           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count == 1)
00365           {
00366             labels[count++] = 
00367               <a class="code" href="classKernelizor.html#p0">_t</a>[2][<a class="code" href="classKernelizor.html#p8">_chainTable</a>[2][pos1]._pos[i]].myLabel();
00368           }
00369         }
00370         <span class="keywordflow">if</span> (count &gt; 1)
00371         {
00372           <span class="comment">// verify that we are not adding two leaves that are a cherry</span>
00373           <span class="comment">// in one of the trees</span>
00374           <span class="keywordflow">if</span> ((k1 &gt;= 0 &amp;&amp; <a class="code" href="classKernelizor.html#p0">_t</a>[2][k1].myLabel() == labels[1]) || 
00375               (k2 &gt;= 0 &amp;&amp; <a class="code" href="classKernelizor.html#p0">_t</a>[3][k2].myLabel() == labels[1]))
00376           {
00377             labels[1] = std::max(labels[1], lab1);
00378             <span class="keywordflow">if</span> (labels[0] == labels[1])
00379               --count;
00380           }
00381         }
00382         <span class="keywordflow">break</span>;
00383       }
00384     }
00385   }
00386   <span class="keywordflow">if</span> (count == 2 &amp;&amp; labels[0] &gt; labels[1])
00387   {
00388     std::swap(labels[0], labels[1]);
00389   }
00390   <span class="keywordflow">return</span> count;
00391 }
00392 
00399 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00400"></a><a class="code" href="classKernelizor.html#b4">00400</a> <span class="keywordtype">int</span> <a class="code" href="classKernelizor.html#b4">Kernelizor&lt;T&gt;::flagChain</a>(T label, T link)
00401 {
00402   <span class="keyword">typename</span> <a class="code" href="classChainTable.html">ChainTable&lt;T&gt;</a>::NList nlist;
00403   nlist._num = 0;
00404 
00405   <span class="comment">// mark first label in chain</span>
00406   <a class="code" href="classKernelizor.html#p8">_chainTable</a>[2].<a class="code" href="classChainTable.html#a7">removeNeighbours</a>(<a class="code" href="classKernelizor.html#p4">_lookup</a>[2][label]);
00407   <a class="code" href="classKernelizor.html#p8">_chainTable</a>[3].<a class="code" href="classChainTable.html#a7">removeNeighbours</a>(<a class="code" href="classKernelizor.html#p4">_lookup</a>[3][label]);
00408 
00409   <span class="comment">// if it has a cherry, mark it too.  we don't wanna loop back on it so</span>
00410   <span class="comment">// dlete it from all its neighbousr</span>
00411   <span class="keywordtype">int</span> cpos = <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[2][<a class="code" href="classKernelizor.html#p4">_lookup</a>[2][label]];
00412   <span class="keywordflow">if</span> (cpos &gt;= 0)
00413   {
00414     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[2].<a class="code" href="classChainTable.html#a8">removeFromNeighbours</a>(cpos);
00415     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[2].<a class="code" href="classChainTable.html#a7">removeNeighbours</a>(cpos);
00416   }
00417   cpos = <a class="code" href="classKernelizor.html#p7">_cherryTable</a>[3][_lookup[3][label]];
00418   <span class="keywordflow">if</span> (cpos &gt;= 0)
00419   {
00420     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[3].<a class="code" href="classChainTable.html#a8">removeFromNeighbours</a>(cpos);
00421     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[3].<a class="code" href="classChainTable.html#a7">removeNeighbours</a>(cpos);
00422   }
00423 
00424   T prev = label;
00425   T links[2];
00426   T temp;
00427   <span class="keywordtype">int</span> linkCount;
00428   <span class="keywordtype">int</span> count = 0;
00429     
00430   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; ; ++i)
00431   {
00432     <span class="comment">// compute labels of common chain neighbours</span>
00433     linkCount = <a class="code" href="classKernelizor.html#b3">chainLinks</a>(link, links);
00434 
00435     <span class="comment">// mark off the element</span>
00436     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[2].<a class="code" href="classChainTable.html#a7">removeNeighbours</a>(_lookup[2][link]);
00437     <a class="code" href="classKernelizor.html#p8">_chainTable</a>[3].<a class="code" href="classChainTable.html#a7">removeNeighbours</a>(_lookup[3][link]);
00438 
00439     <span class="comment">// if a middle element and not the second, flag it for</span>
00440     <span class="comment">// freeze/deletion</span>
00441     <span class="keywordflow">if</span> (linkCount == 2 &amp;&amp; i &gt; 0)
00442     {
00443       <span class="comment">//std::cout &lt;&lt; "flaggin " &lt;&lt; link &lt;&lt; std::endl;</span>
00444       <a class="code" href="classKernelizor.html#p6">_ftable</a>[2].setFrozen(_lookup[2][link], <span class="keyword">true</span>);
00445       <a class="code" href="classKernelizor.html#p6">_ftable</a>[2].setDel(_lookup[2][link], <span class="keyword">true</span>);
00446       <a class="code" href="classKernelizor.html#p6">_ftable</a>[3].setFrozen(_lookup[3][link], <span class="keyword">true</span>);
00447       <a class="code" href="classKernelizor.html#p6">_ftable</a>[3].setDel(_lookup[3][link], <span class="keyword">true</span>);
00448       ++count;
00449       
00450       <span class="comment">// if we are flagging for the first time (3rd common element in chain,</span>
00451       <span class="comment">// first after link (i == 1)</span>
00452       <span class="comment">// then mark the prvious element as frozen for rekernelization</span>
00453       <span class="keywordflow">if</span> (i == 1)
00454       {
00455         <a class="code" href="classKernelizor.html#p6">_ftable</a>[2].setFrozen(_lookup[2][prev], <span class="keyword">true</span>);
00456         <a class="code" href="classKernelizor.html#p6">_ftable</a>[3].setFrozen(_lookup[3][prev], <span class="keyword">true</span>);
00457       }
00458     }
00459     temp = link;
00460     <span class="keywordflow">if</span> (linkCount == 2 &amp;&amp; links[0] == prev)
00461       link = links[1];
00462     <span class="keywordflow">else</span>
00463       link = links[0];
00464     prev = temp;
00465     <span class="keywordflow">if</span> (linkCount &lt;= 1)
00466       <span class="keywordflow">break</span>;
00467   }
00468   <span class="keywordflow">return</span> count;
00469 }
00470 
00475 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00476"></a><a class="code" href="classKernelizor.html#b6">00476</a> <span class="keywordtype">void</span> <a class="code" href="classKernelizor.html#b6">Kernelizor&lt;T&gt;::copyFromTemp</a>()
00477 {
00478   <span class="comment">// we are copying rule 2 flags so set flagtable states accordingly</span>
00479   <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].setRuleState(1);
00480   <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].setRuleState(1);
00481 
00482   <span class="keywordtype">int</span> i;
00483   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classKernelizor.html#p3">_tempSize</a>; ++i)
00484   {
00485     <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a>)
00486     {
00487       <span class="comment">// leaf flagged by rule 2 but not rule 1</span>
00488       <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p6">_ftable</a>[2].isDel(i) == <span class="keyword">true</span> &amp;&amp;
00489           <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].isDel(<a class="code" href="classKernelizor.html#p4">_lookup</a>[0][<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myLabel()]) == <span class="keyword">false</span>)
00490       {
00491         <span class="comment">// flag it on original (t[0,1]) trees</span>
00492         <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].flagLeaf(<a class="code" href="classKernelizor.html#p4">_lookup</a>[0][<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myLabel()]);
00493         <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].flagLeaf(<a class="code" href="classKernelizor.html#p4">_lookup</a>[1][<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myLabel()]);
00494       }
00495       
00496       <span class="comment">// leaf forzen by rule 2</span>
00497       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p6">_ftable</a>[2].isFrozen(i) == <span class="keyword">true</span>)
00498       {
00499         <a class="code" href="classKernelizor.html#p6">_ftable</a>[0].setFrozen(<a class="code" href="classKernelizor.html#p4">_lookup</a>[0][<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myLabel()], <span class="keyword">true</span>);
00500         <a class="code" href="classKernelizor.html#p6">_ftable</a>[1].setFrozen(<a class="code" href="classKernelizor.html#p4">_lookup</a>[1][<a class="code" href="classKernelizor.html#p0">_t</a>[2][i].myLabel()], <span class="keyword">true</span>);
00501       }
00502     }
00503   }
00504 
00505   <span class="comment">// copy _meta.flags into t0 and t1</span>
00506   <span class="comment">// These flags are deprecated and on their way out!! </span>
00507   <span class="comment">// Only flag table is gonna be looked at from now on!!</span>
00508   <span class="keywordflow">for</span> (i = 0; i &lt; _man-&gt;treeSize(); ++i)
00509   {
00510     <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p6">_ftable</a>[0].isDel(i) == <span class="keyword">true</span>)
00511       <a class="code" href="classKernelizor.html#p0">_t</a>[0][i].setFlag(<span class="keyword">true</span>);
00512     
00513     <span class="keywordflow">if</span> (<a class="code" href="classKernelizor.html#p6">_ftable</a>[1].isDel(i) == <span class="keyword">true</span>)
00514       <a class="code" href="classKernelizor.html#p0">_t</a>[1][i].setFlag(<span class="keyword">true</span>);
00515   }
00516 }
00517 
00521 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00522"></a><a class="code" href="kernelizor__impl_8h.html#a0">00522</a> std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, Kernelizor&lt;T&gt;&amp; kern)
00523 {
00524   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 2; ++i)
00525   {
00526     os &lt;&lt; <span class="stringliteral">"T"</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">":\n"</span> &lt;&lt; kern._t[i] &lt;&lt; std::endl;
00527     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; kern._t[i].size(); ++j)
00528     {
00529       <span class="keywordflow">if</span> (kern._ftable[i][j])
00530         os &lt;&lt; (int)kern._ftable[i][j];
00531       <span class="keywordflow">else</span>
00532         os &lt;&lt; <span class="charliteral">'_'</span>;
00533       <span class="keywordflow">if</span> (kern._t[i][j].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a> &amp;&amp; kern._t[i][j].myLabel() &gt; 9)
00534         os &lt;&lt; <span class="charliteral">'.'</span>;
00535     }
00536     os &lt;&lt; std::endl;
00537   }
00538 
00539   os &lt;&lt; <span class="stringliteral">"\n"</span>;
00540 
00541   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 2; i &lt; 4; ++i)
00542   {
00543     os &lt;&lt; <span class="stringliteral">"Temp"</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">":\n"</span> &lt;&lt; kern._t[i] &lt;&lt; std::endl;
00544   }
00545   <span class="keywordflow">return</span> os;
00546 }
00547 
00548 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Oct 2 18:43:18 2006 for SPR by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
