<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SPR: treecache_impl.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>treecache_impl.h</h1><a href="treecache__impl_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#ifndef _TREECACHE_IMPL_H</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define _TREECACHE_IMPL_H</span>
00003 <span class="preprocessor"></span>
00004 <span class="preprocessor">#include "<a class="code" href="uptree_8h.html">uptree.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="treemanager_8h.html">treemanager.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="crc32_8h.html">crc32.h</a>"</span>
00007 
<a name="l00008"></a><a class="code" href="treecache__impl_8h.html#a0">00008</a> <span class="keyword">static</span> <span class="keyword">const</span> size_t <a class="code" href="treecache__impl_8h.html#a0">MAX_NODE_OS</a> = 134217728 - 1; <span class="comment">// 2^27 - 1</span>
00009 
00014 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00015"></a><a class="code" href="classTreeCache.html#a0">00015</a> <a class="code" href="classTreeCache.html#d0">TreeCache&lt;T&gt;::TreeCache</a>(size_t n, <a class="code" href="classTreeManager.html">TreeManager&lt;T&gt;</a>* man) : _man(man), 
00016   _tabSize(n), _size(0), _hits(0), _updates(0), _collisions(0)
00017 {
00018   <a class="code" href="classTreeCache.html#p1">_tab</a> = (<a class="code" href="structTreeCache_1_1Node.html">Node</a>*)malloc(<a class="code" href="classTreeCache.html#p2">_tabSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="structTreeCache_1_1Node.html">Node</a>));
00019   <span class="keywordflow">for</span> (size_t i = 0; i &lt; <a class="code" href="classTreeCache.html#p2">_tabSize</a>; ++i)
00020   {
00021     <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o0">_os</a> = <a class="code" href="treecache__impl_8h.html#a0">MAX_NODE_OS</a>;
00022     <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a> = NULL;
00023   }
00024 }
00025 
00026 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00027"></a><a class="code" href="classTreeCache.html#a1">00027</a> <a class="code" href="classTreeCache.html#a1">TreeCache&lt;T&gt;::~TreeCache</a>()
00028 {
00029   <a class="code" href="structTreeCache_1_1Node.html">Node</a>* n;
00030   <span class="keywordflow">for</span> (size_t i = 0; i &lt; <a class="code" href="classTreeCache.html#p2">_tabSize</a>; ++i)
00031   {
00032     <span class="keywordflow">if</span> (<a class="code" href="classTreeCache.html#p1">_tab</a>[i]._os &gt;= 0)
00033     {
00034       <span class="keywordflow">while</span> (<a class="code" href="classTreeCache.html#p1">_tab</a>[i]._next)
00035       {
00036         n = <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a>;
00037         <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a> = <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a>-&gt;<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a>;
00038         free(n);
00039       }
00040     }
00041   }
00042   free(<a class="code" href="classTreeCache.html#p1">_tab</a>);
00043 }
00044 
00048 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00049"></a><a class="code" href="classTreeCache.html#a2">00049</a> <span class="keywordtype">void</span> <a class="code" href="classTreeCache.html#a2">TreeCache&lt;T&gt;::reset</a>()
00050 {
00051   <a class="code" href="structTreeCache_1_1Node.html">Node</a>* n;
00052   <span class="keywordflow">for</span> (size_t i = 0; i &lt; <a class="code" href="classTreeCache.html#p2">_tabSize</a>; ++i)
00053   {
00054     <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o0">_os</a> = <a class="code" href="treecache__impl_8h.html#a0">MAX_NODE_OS</a>;
00055     <span class="keywordflow">while</span> (<a class="code" href="classTreeCache.html#p1">_tab</a>[i]._next != NULL)
00056     {
00057       n = <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a>;
00058       <a class="code" href="classTreeCache.html#p1">_tab</a>[i].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a> = n-&gt;<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a>;
00059       free(n);
00060     }
00061   }
00062    <a class="code" href="classTreeCache.html#p3">_size</a> = 0;
00063    <a class="code" href="classTreeCache.html#o0">_hits</a> = 0;
00064    <a class="code" href="classTreeCache.html#o1">_updates</a> = 0;
00065    <a class="code" href="classTreeCache.html#o2">_collisions</a> = 0;
00066 }
00067 
00071 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00072"></a><a class="code" href="classTreeCache.html#a3">00072</a> <span class="keyword">inline</span> size_t <a class="code" href="classTreeCache.html#a3">TreeCache&lt;T&gt;::size</a>()<span class="keyword"> const </span>{
00073   <span class="keywordflow">return</span> <a class="code" href="classTreeCache.html#p3">_size</a>;
00074 }
00075 
00080 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00081"></a><a class="code" href="classTreeCache.html#a4">00081</a> <span class="keyword">inline</span> <span class="keyword">typename</span> <a class="code" href="classTreeCache.html">TreeCache&lt;T&gt;</a><a class="code" href="structTreeCache_1_1Result.html">::Result</a>  <a class="code" href="classTreeCache.html#a4">TreeCache&lt;T&gt;::update</a>(
00082   <span class="keyword">const</span> <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; tree, size_t flag, size_t iter)
00083 {
00084   assert(<a class="code" href="classTreeCache.html#p0">_man</a> == tree._man);
00085   <span class="keywordflow">return</span> <a class="code" href="classTreeCache.html#a4">update</a>(static_cast&lt;size_t&gt;(tree._os), flag, iter);
00086 }
00087 
00092 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00093"></a><a class="code" href="classTreeCache.html#a5">00093</a> <span class="keyword">typename</span> <a class="code" href="classTreeCache.html">TreeCache&lt;T&gt;</a><a class="code" href="structTreeCache_1_1Result.html">::Result</a> <a class="code" href="classTreeCache.html#a4">TreeCache&lt;T&gt;::update</a>(size_t os, 
00094                                                    size_t flag, 
00095                                                    size_t iter)
00096 {
00097   <a class="code" href="structTreeCache_1_1Result.html">Result</a> res;
00098   res.<a class="code" href="structTreeCache_1_1Result.html#o0">_hit</a> = 0;
00099   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx = <a class="code" href="classTreeCache.html#b0">hash</a>(os);
00100   ++<a class="code" href="classTreeCache.html#o1">_updates</a>;
00101 
00102   <span class="comment">// Non-empty node</span>
00103   <span class="keywordflow">if</span> (<a class="code" href="classTreeCache.html#p1">_tab</a>[idx]._os != <a class="code" href="treecache__impl_8h.html#a0">MAX_NODE_OS</a>)
00104   {
00105     <span class="keywordflow">if</span> (<a class="code" href="classTreeCache.html#p0">_man</a>-&gt;compare(os, <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o0">_os</a>) == <span class="keyword">true</span>)
00106     {
00107       res.<a class="code" href="structTreeCache_1_1Result.html#o0">_hit</a> = 1;
00108       res.<a class="code" href="structTreeCache_1_1Result.html#o2">_it</a> = <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o2">_it</a>;
00109       res.<a class="code" href="structTreeCache_1_1Result.html#o1">_flag</a> = <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o1">_flag</a>;
00110       ++<a class="code" href="classTreeCache.html#o0">_hits</a>;
00111     }
00112     <span class="keywordflow">else</span>
00113     {
00114       <span class="keywordflow">for</span> (<a class="code" href="structTreeCache_1_1Node.html">Node</a>* n = <a class="code" href="classTreeCache.html#p1">_tab</a>[idx]._next; n; n = n-&gt;<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a>)
00115       {
00116         <span class="keywordflow">if</span> (<a class="code" href="classTreeCache.html#p0">_man</a>-&gt;compare(os, n-&gt;_os))
00117         {
00118           res.<a class="code" href="structTreeCache_1_1Result.html#o0">_hit</a> = 1;
00119           res.<a class="code" href="structTreeCache_1_1Result.html#o2">_it</a> = n-&gt;<a class="code" href="structTreeCache_1_1Result.html#o2">_it</a>;
00120           res.<a class="code" href="structTreeCache_1_1Result.html#o1">_flag</a> = n-&gt;<a class="code" href="structTreeCache_1_1Result.html#o1">_flag</a>;
00121           ++<a class="code" href="classTreeCache.html#o0">_hits</a>;
00122           <span class="keywordflow">break</span>;
00123         }
00124       }
00125     }
00126     <span class="keywordflow">if</span> (res.<a class="code" href="structTreeCache_1_1Result.html#o0">_hit</a> == 0)
00127     {
00128       ++<a class="code" href="classTreeCache.html#o2">_collisions</a>;
00129       <a class="code" href="structTreeCache_1_1Node.html">Node</a>* newNode = (<a class="code" href="structTreeCache_1_1Node.html">Node</a>*)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structTreeCache_1_1Node.html">Node</a>));
00130       *newNode = <a class="code" href="classTreeCache.html#p1">_tab</a>[idx];
00131       <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o0">_os</a> = os;
00132       <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o1">_flag</a> = flag;
00133       <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o2">_it</a> = iter;
00134       <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a> = newNode;
00135       ++<a class="code" href="classTreeCache.html#p3">_size</a>;
00136     }
00137   }
00138   <span class="comment">// empty node</span>
00139   <span class="keywordflow">else</span>
00140   {
00141     <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o0">_os</a> = os;
00142     <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o1">_flag</a> = flag;
00143     <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o2">_it</a> = iter;
00144     <a class="code" href="classTreeCache.html#p1">_tab</a>[idx].<a class="code" href="structTreeCache_1_1Node.html#o3">_next</a> = NULL;
00145     ++<a class="code" href="classTreeCache.html#p3">_size</a>;
00146   }
00147   <span class="keywordflow">return</span> res;
00148 }
00149 
00155 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00156"></a><a class="code" href="classTreeCache.html#b0">00156</a> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classTreeCache.html#b0">TreeCache&lt;T&gt;::hash</a>(size_t os)
00157 {
00158   <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a> tree = {os, <a class="code" href="classTreeCache.html#p0">_man</a>};
00159   <span class="keywordflow">return</span> <a class="code" href="classCrc32.html#e0">Crc32&lt;T&gt;::getInstance</a>()-&gt;<a class="code" href="classCrc32.html#a0">crc</a>(tree) % <a class="code" href="classTreeCache.html#p2">_tabSize</a>;
00160 }
00161 
00162 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Oct 2 18:43:18 2006 for SPR by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
