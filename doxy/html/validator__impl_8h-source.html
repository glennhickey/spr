<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SPR: validator_impl.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>validator_impl.h</h1><a href="validator__impl_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#ifndef _VALIDATOR_IMPL_H</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define _VALIDATOR_IMPL_H</span>
00003 <span class="preprocessor"></span>
00004 <span class="preprocessor">#include &lt;limits&gt;</span>
00005 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00006 
00011 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00012"></a><a class="code" href="classValidator.html#a0">00012</a> <a class="code" href="classValidator.html#d0">Validator&lt;T&gt;::Validator</a>(<span class="keywordtype">int</span> size) : _table(size)
00013 {
00014 
00015 }
00016 
00017 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00018"></a><a class="code" href="classValidator.html#a1">00018</a> <a class="code" href="classValidator.html#a1">Validator&lt;T&gt;::~Validator</a>()
00019 {
00020 
00021 }
00022 
00027 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00028"></a><a class="code" href="classValidator.html#a6">00028</a> <span class="keyword">inline</span> <span class="keyword">const</span> <a class="code" href="classBracketTable.html">BracketTable&lt;T&gt;</a>&amp; <a class="code" href="classValidator.html#a6">Validator&lt;T&gt;::getBTable</a>()<span class="keyword"> const </span>
00029 <span class="keyword"></span>{
00030   <span class="keywordflow">return</span> <a class="code" href="classValidator.html#p0">_table</a>;
00031 }
00032 
00037 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00038"></a><a class="code" href="classValidator.html#a7">00038</a> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classValidator.html#a7">Validator&lt;T&gt;::getSize</a>()<span class="keyword"> const </span>
00039 <span class="keyword"></span>{
00040   <span class="keywordflow">return</span> <a class="code" href="classValidator.html#p0">_table</a>.getSize();
00041 }
00042 
00047 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00048"></a><a class="code" href="classValidator.html#a2">00048</a> <span class="keywordtype">bool</span> <a class="code" href="classValidator.html#a2">Validator&lt;T&gt;::validTree</a>(<span class="keyword">const</span> <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; tree)
00049 {
00050   <span class="keywordflow">if</span> (tree[0].myType() != <a class="code" href="treetok_8h.html#a4a0">LB</a>)
00051     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00052 
00053   <span class="keywordtype">int</span> pos = 1;
00054   <span class="keywordtype">int</span> delta, i;
00055   <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++i)
00056   {
00057     delta = <a class="code" href="classValidator.html#a3">subtreeSize</a>(tree, pos);
00058     <span class="keywordflow">if</span> (!delta)
00059       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00060     pos += delta;
00061   }
00062   
00063   <span class="keywordflow">return</span> pos == tree.size() - 1 &amp;&amp; tree[pos].myType() == <a class="code" href="treetok_8h.html#a4a1">RB</a>;
00064 }
00065 
00073 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00074"></a><a class="code" href="classValidator.html#a3">00074</a> <span class="keywordtype">int</span> <a class="code" href="classValidator.html#a3">Validator&lt;T&gt;::subtreeSize</a>(<span class="keyword">const</span> <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; tree, <span class="keywordtype">int</span> pos)
00075 {
00076   <span class="keywordtype">int</span> i = pos;
00077   
00078   <span class="keywordflow">if</span> (tree[i].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a>)
00079     <span class="keywordflow">return</span> 1;
00080 
00081   assert(<a class="code" href="classValidator.html#p1">_stack</a>.empty());
00082 
00083   <span class="keywordflow">do</span> 
00084   {
00085     <span class="keywordflow">if</span> (i &gt;= tree.size())
00086       <span class="keywordflow">return</span> 0;
00087 
00088     <span class="comment">// left bracket: push to stack &amp; increase subtree count</span>
00089     <span class="keywordflow">if</span> (tree[i].myType() == <a class="code" href="treetok_8h.html#a4a0">LB</a>)
00090     {
00091       <span class="keywordflow">if</span> (!<a class="code" href="classValidator.html#p1">_stack</a>.empty())
00092         ++<a class="code" href="classValidator.html#p1">_stack</a>.top();
00093       <a class="code" href="classValidator.html#p1">_stack</a>.push(0);
00094     }
00095     <span class="comment">// right bracket: pop from stack</span>
00096     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tree[i].myType() == <a class="code" href="treetok_8h.html#a4a1">RB</a>) 
00097     {
00098       <span class="keywordflow">if</span> (<a class="code" href="classValidator.html#p1">_stack</a>.empty() || <a class="code" href="classValidator.html#p1">_stack</a>.top() != 2)
00099         <span class="keywordflow">return</span> 0;
00100       <a class="code" href="classValidator.html#p1">_stack</a>.pop();
00101     }
00102     <span class="comment">// leaf: increase subtree count</span>
00103     <span class="keywordflow">else</span>
00104     {
00105       <span class="keywordflow">if</span> (<a class="code" href="classValidator.html#p1">_stack</a>.empty() || <a class="code" href="classValidator.html#p1">_stack</a>.top() &gt; 2)
00106         <span class="keywordflow">return</span> 0;
00107       ++<a class="code" href="classValidator.html#p1">_stack</a>.top();
00108     }
00109     ++i;
00110   } <span class="keywordflow">while</span> (!<a class="code" href="classValidator.html#p1">_stack</a>.empty());
00111   
00112   <span class="keywordflow">if</span> (!<a class="code" href="classValidator.html#p1">_stack</a>.empty())
00113     <span class="keywordflow">while</span>(!<a class="code" href="classValidator.html#p1">_stack</a>.empty()) <a class="code" href="classValidator.html#p1">_stack</a>.pop();
00114 
00115   <span class="keywordflow">return</span> i - pos;
00116 }
00117 
00130 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00131"></a><a class="code" href="classValidator.html#b0">00131</a> <span class="keywordtype">int</span> <a class="code" href="classValidator.html#b0">Validator&lt;T&gt;::reorderSubtree</a>(<span class="keyword">const</span> <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; itree, <span class="keywordtype">int</span> pos, 
00132                                     <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; otree, <span class="keywordtype">int</span> opos)
00133 {
00134   assert(<a class="code" href="classValidator.html#p1">_stack</a>.empty());
00135 
00136   <span class="keywordtype">int</span> idx;
00137   <span class="keywordtype">int</span> swaps = 0;
00138 
00139   <a class="code" href="classValidator.html#p1">_stack</a>.push(pos);
00140 
00141   <span class="keywordflow">while</span> (!<a class="code" href="classValidator.html#p1">_stack</a>.empty())
00142   {
00143     idx = <a class="code" href="classValidator.html#p1">_stack</a>.top();
00144     <a class="code" href="classValidator.html#p1">_stack</a>.pop();
00145     
00146     <span class="comment">// left bracket:  copy left bracket</span>
00147     <span class="comment">// copy min subtree. then copy max subtree</span>
00148     <span class="comment">// using stack so first is last. .. </span>
00149     <span class="keywordflow">if</span> (itree[idx].myType() == <a class="code" href="treetok_8h.html#a4a0">LB</a>)
00150     {
00151       otree[opos++] = itree[idx];
00152       <a class="code" href="classValidator.html#p1">_stack</a>.push(<a class="code" href="classValidator.html#p0">_table</a>[idx].pos[1]);
00153       <span class="keywordflow">if</span> (<a class="code" href="classValidator.html#p0">_table</a>[idx].min[0] &lt; <a class="code" href="classValidator.html#p0">_table</a>[idx].min[1])
00154       {
00155         <a class="code" href="classValidator.html#p1">_stack</a>.push(<a class="code" href="classValidator.html#p0">_table</a>[idx].rPos);
00156         <a class="code" href="classValidator.html#p1">_stack</a>.push(idx + 1);
00157       }
00158       <span class="keywordflow">else</span>
00159       {
00160         ++swaps;
00161         <a class="code" href="classValidator.html#p1">_stack</a>.push(idx + 1);
00162         <a class="code" href="classValidator.html#p1">_stack</a>.push(<a class="code" href="classValidator.html#p0">_table</a>[idx].rPos);
00163       }
00164     }
00165     <span class="comment">// right bracket: write it and pop the matching left</span>
00166     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itree[idx].myType() == <a class="code" href="treetok_8h.html#a4a1">RB</a>)
00167     {
00168       otree[opos++] = itree[idx];
00169     }
00170     <span class="comment">// leaf: copy label into new tree</span>
00171     <span class="keywordflow">else</span> 
00172     {
00173       otree[opos++] = itree[idx];
00174     }
00175   }  
00176   <span class="keywordflow">return</span> swaps;
00177 }
00178 
00187 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00188"></a><a class="code" href="classValidator.html#a4">00188</a> <span class="keywordtype">int</span> <a class="code" href="classValidator.html#a4">Validator&lt;T&gt;::reorder</a>(<span class="keyword">const</span> <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; itree, <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; otree)
00189 {
00190   <span class="keywordtype">int</span> triPos[3];
00191   <a class="code" href="classValidator.html#p0">_table</a>.loadTree(itree);
00192   <a class="code" href="classValidator.html#p0">_table</a>.getTriPos(triPos);
00193      
00194   otree[0] = itree[0];
00195   
00196   <span class="comment">// collect minimum value of each subtree</span>
00197   T minVal[3];
00198   <span class="keywordflow">if</span> (itree[triPos[0]].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a>)
00199     minVal[0] = itree[triPos[0]].myLabel();
00200   <span class="keywordflow">else</span>
00201     minVal[0] = std::min(<a class="code" href="classValidator.html#p0">_table</a>[triPos[0]].min[0], <a class="code" href="classValidator.html#p0">_table</a>[triPos[0]].min[1]);
00202   <span class="keywordflow">if</span> (itree[triPos[1]].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a>)
00203     minVal[1] = itree[triPos[1]].myLabel();
00204   <span class="keywordflow">else</span>
00205     minVal[1] = std::min(<a class="code" href="classValidator.html#p0">_table</a>[triPos[1]].min[0], <a class="code" href="classValidator.html#p0">_table</a>[triPos[1]].min[1]);
00206   <span class="keywordflow">if</span> (itree[triPos[2]].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a>)
00207     minVal[2] = itree[triPos[2]].myLabel();
00208   <span class="keywordflow">else</span>
00209     minVal[2] = std::min(<a class="code" href="classValidator.html#p0">_table</a>[triPos[2]].min[0], <a class="code" href="classValidator.html#p0">_table</a>[triPos[2]].min[1]);
00210 
00211   <span class="comment">// sort subtrees by their minimum values</span>
00212   <span class="keywordtype">int</span> order[3] = {0, 1, 2};
00213   <span class="keywordflow">if</span> (minVal[order[1]] &lt; minVal[order[0]])
00214     std::swap(order[0], order[1]);
00215   <span class="keywordflow">if</span> (minVal[order[2]] &lt; minVal[order[1]])
00216     std::swap(order[1], order[2]);
00217   <span class="keywordflow">if</span> (minVal[order[1]] &lt; minVal[order[0]])
00218     std::swap(order[0], order[1]);
00219 
00220   <span class="comment">// reorder subtrees in sorted order</span>
00221   <span class="keywordtype">int</span> swaps = <a class="code" href="classValidator.html#b0">reorderSubtree</a>(itree, triPos[order[0]], otree, triPos[0]);
00222   <span class="keywordtype">int</span> size = <a class="code" href="classValidator.html#p0">_table</a>[triPos[order[0]]].pos[1] - triPos[order[0]] + 1;
00223   swaps += <a class="code" href="classValidator.html#b0">reorderSubtree</a>(itree, triPos[order[1]], otree, triPos[0] + size);
00224   size += <a class="code" href="classValidator.html#p0">_table</a>[triPos[order[1]]].pos[1] - triPos[order[1]] + 1;
00225   swaps += <a class="code" href="classValidator.html#b0">reorderSubtree</a>(itree, triPos[order[2]], otree, triPos[0] + size);
00226   
00227   otree[itree.size() - 1] = itree[itree.size() - 1];
00228 
00229   <span class="keywordflow">return</span> swaps;
00230 }
00231 
00255 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00256"></a><a class="code" href="classValidator.html#a5">00256</a> <span class="keywordtype">int</span> <a class="code" href="classValidator.html#a5">Validator&lt;T&gt;::retrifurcate</a>(<span class="keyword">const</span> <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; itree, <a class="code" href="structUPTree.html">UPTree&lt;T&gt;</a>&amp; otree, 
00257                                T root)
00258 {
00259   <span class="keywordtype">int</span> i, j, k;
00260   <span class="keywordtype">int</span> triPos[3];
00261   T rPos = 0;
00262 
00263   <a class="code" href="classValidator.html#p0">_table</a>.loadTree(itree);
00264   <a class="code" href="classValidator.html#p0">_table</a>.getTriPos(triPos);
00265 
00266   <span class="comment">// find 'root' leaf</span>
00267   rPos = itree.getPos(root);
00268   assert(rPos &gt; 0);
00269 
00270   <span class="keywordtype">int</span> minTri = 0;
00271   <span class="keywordflow">if</span> (rPos &gt;= triPos[1])
00272     minTri = 1;
00273   <span class="keywordflow">if</span> (rPos &gt;= triPos[2])
00274     minTri = 2;
00275 
00276   <span class="comment">// already trifurcated.  do nothing (note it may not be in right order)</span>
00277   <span class="keywordflow">if</span> (rPos == triPos[minTri])
00278   {
00279     otree.duplicate(itree);
00280     <span class="keywordflow">return</span> 0;
00281   }
00282 
00283   j = 0;
00284 
00285   <span class="comment">// create new LEFT subtree</span>
00286   otree[j++] = itree[0];
00287   otree[j++] = itree[rPos];
00288   
00289   <span class="comment">// create MIDDLE subtree out of mins neighbour which</span>
00290   <span class="comment">// can be a right leaf, left leaf, right neighbour or left neighbour</span>
00291   <span class="keywordtype">int</span> midLeft = 0;
00292   <span class="keywordtype">int</span> midRight = 0;
00293   <span class="keywordflow">if</span> (itree[rPos + 1].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a> ||
00294       itree[rPos + 1].myType() == <a class="code" href="treetok_8h.html#a4a0">LB</a>)
00295   {
00296     midLeft = rPos + 1;
00297     midRight = <a class="code" href="classValidator.html#p0">_table</a>[midLeft].pos[1];
00298   }
00299   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itree[rPos - 1].myType() == <a class="code" href="treetok_8h.html#a4a2">LEAF</a> ||
00300            itree[rPos - 1].myType() == <a class="code" href="treetok_8h.html#a4a1">RB</a>)
00301   {
00302     midRight = rPos - 1;
00303     midLeft = <a class="code" href="classValidator.html#p0">_table</a>[midRight].pos[0];
00304   }
00305   <span class="keywordflow">for</span> (i = midLeft; i &lt;= midRight; ++i)
00306   {
00307     otree[j++] = itree[i];
00308   } 
00309   
00310   <span class="comment">// create RIGHT subtree</span>
00311   
00312   <span class="comment">// flip everything above of min in the nesting</span>
00313   i = midLeft - 1;
00314   <span class="keywordflow">if</span> (i == rPos)
00315     --i;
00316   <span class="keywordflow">for</span>(; i &gt;= triPos[minTri]; --i)
00317   {
00318     <span class="comment">// if entire subtree is within this range, copy as is (don't flip)</span>
00319     <span class="keywordflow">if</span> (itree[i].myType() == <a class="code" href="treetok_8h.html#a4a1">RB</a>)
00320     {
00321       <span class="keywordflow">for</span> (k = <a class="code" href="classValidator.html#p0">_table</a>[i].pos[0]; k &lt;= i; ++k)
00322         otree[j++] = itree[k];
00323       i = <a class="code" href="classValidator.html#p0">_table</a>[i].pos[0];
00324       }
00325       <span class="keywordflow">else</span> 
00326       otree[j++] = itree[i];
00327   }
00328   
00329   <span class="comment">// add all remaining leaves beginning with the original trifurcation</span>
00330   <span class="comment">// subtrees that do not contain min;</span>
00331   <span class="keywordtype">int</span> s1 = rPos &lt; triPos[1] ? 1 : 0;
00332   <span class="keywordtype">int</span> s2 = rPos &gt; triPos[2] ? 1 : 2;
00333   <span class="keywordflow">for</span> (i = triPos[s1]; i &lt;= <a class="code" href="classValidator.html#p0">_table</a>[triPos[s1]].pos[1]; ++i)
00334   {
00335     otree[j++] = itree[i];
00336   }
00337   <span class="keywordflow">for</span> (i = triPos[s2]; i &lt;= <a class="code" href="classValidator.html#p0">_table</a>[triPos[s2]].pos[1]; ++i)
00338   {
00339     otree[j++] = itree[i];
00340   }
00341   
00342   <span class="comment">// add remaining items from split subtree</span>
00343   i = midRight + 1;
00344   <span class="keywordflow">if</span> (i == rPos)
00345     ++i;
00346   <span class="comment">/*</span>
00347 <span class="comment">  for (; i &lt;= _table[triPos[minTri]].pos[1]; ++i)</span>
00348 <span class="comment">  {</span>
00349 <span class="comment">    otree[j++] = itree[i];</span>
00350 <span class="comment">  }</span>
00351 <span class="comment">  */</span>
00352   <span class="comment">// try backwards:</span>
00353   <span class="keywordtype">int</span> p = i;
00354   <span class="keywordflow">for</span> (i = <a class="code" href="classValidator.html#p0">_table</a>[triPos[minTri]].pos[1]; i &gt;= p; --i)
00355   {
00356     <span class="comment">// if entire subtree is within this range, copy as is (don't flip)</span>
00357     <span class="keywordflow">if</span> (itree[i].myType() == <a class="code" href="treetok_8h.html#a4a1">RB</a> &amp;&amp; <a class="code" href="classValidator.html#p0">_table</a>[i].pos[0] &gt; p)
00358     {
00359       <span class="keywordflow">for</span> (k = <a class="code" href="classValidator.html#p0">_table</a>[i].pos[0]; k &lt;= i; ++k)
00360         otree[j++] = itree[k];
00361       i = <a class="code" href="classValidator.html#p0">_table</a>[i].pos[0];
00362     }
00363     <span class="keywordflow">else</span> 
00364       otree[j++] = itree[i];
00365   } 
00366 
00367   <span class="comment">// add last bracket</span>
00368   otree[j++] = itree[itree.size() - 1];
00369   
00370   assert(j == itree.size());
00371     
00372   <span class="keywordflow">return</span> 1;
00373 }
00374 
00375 
00376 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Oct 2 18:43:18 2006 for SPR by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
